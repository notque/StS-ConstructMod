name: Build Mod

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Create lib directory
      run: mkdir -p ../lib

    - name: Download ModTheSpire
      run: |
        # ModTheSpire releases contain a JAR directly
        echo "Downloading ModTheSpire..."
        curl -L -f -o ../lib/ModTheSpire.jar \
          "https://github.com/kiooeht/ModTheSpire/releases/download/v3.30.3/ModTheSpire.jar" || {
          echo "Direct download failed, trying latest release..."
          # Get the latest release download URL
          RELEASE_URL=$(curl -s https://api.github.com/repos/kiooeht/ModTheSpire/releases/latest | jq -r '.assets[] | select(.name=="ModTheSpire.jar") | .browser_download_url')
          if [ -n "$RELEASE_URL" ] && [ "$RELEASE_URL" != "null" ]; then
            curl -L -f -o ../lib/ModTheSpire.jar "$RELEASE_URL"
          else
            echo "ERROR: Could not find ModTheSpire.jar in release"
            exit 1
          fi
        }
        ls -la ../lib/ModTheSpire.jar

    - name: Download BaseMod
      run: |
        echo "Downloading BaseMod..."
        # Try direct download first
        curl -L -f -o ../lib/BaseMod.jar \
          "https://github.com/daviscook477/BaseMod/releases/download/v5.54.1/BaseMod.jar" || {
          echo "Direct download failed, trying latest release..."
          RELEASE_URL=$(curl -s https://api.github.com/repos/daviscook477/BaseMod/releases/latest | jq -r '.assets[] | select(.name=="BaseMod.jar") | .browser_download_url')
          if [ -n "$RELEASE_URL" ] && [ "$RELEASE_URL" != "null" ]; then
            curl -L -f -o ../lib/BaseMod.jar "$RELEASE_URL"
          else
            echo "ERROR: Could not find BaseMod.jar in release"
            exit 1
          fi
        }
        ls -la ../lib/BaseMod.jar

    - name: Download StSLib
      run: |
        echo "Downloading StSLib..."
        curl -L -f -o ../lib/StSLib.jar \
          "https://github.com/kiooeht/StSLib/releases/download/v2.1.1/StSLib.jar" || {
          echo "Direct download failed, trying latest release..."
          RELEASE_URL=$(curl -s https://api.github.com/repos/kiooeht/StSLib/releases/latest | jq -r '.assets[] | select(.name=="StSLib.jar") | .browser_download_url')
          if [ -n "$RELEASE_URL" ] && [ "$RELEASE_URL" != "null" ]; then
            curl -L -f -o ../lib/StSLib.jar "$RELEASE_URL"
          else
            echo "ERROR: Could not find StSLib.jar in release"
            exit 1
          fi
        }
        ls -la ../lib/StSLib.jar

    - name: Download Slay the Spire desktop JAR (stub)
      run: |
        echo "Downloading STS desktop stub..."
        # Use the community-maintained mod compile dependencies
        # This contains only the class signatures needed for compilation
        curl -L -f -o ../lib/desktop-1.0.jar \
          "https://raw.githubusercontent.com/Gremious/StS-DefaultModBase/master/lib/desktop-1.0.jar" || \
        curl -L -f -o ../lib/desktop-1.0.jar \
          "https://github.com/Alchyr/BasicMod/raw/master/lib/desktop-1.0.jar" || {
          echo "WARNING: Could not download desktop-1.0.jar stub"
          echo "Build will likely fail - game JAR needed for compilation"
          # Create minimal empty jar as last resort
          echo "Manifest-Version: 1.0" > manifest.txt
          jar cfm ../lib/desktop-1.0.jar manifest.txt
          rm manifest.txt
        }
        ls -la ../lib/desktop-1.0.jar

    - name: Create placeholder for optional dependencies
      run: |
        # ReplayTheSpire is optional, create empty JAR
        echo "Manifest-Version: 1.0" > manifest.txt
        jar cfm ../lib/ReplayTheSpireMod.jar manifest.txt
        rm manifest.txt
        ls -la ../lib/

    - name: Verify downloaded JARs
      run: |
        echo "Verifying JAR files..."
        for jar in ../lib/*.jar; do
          echo "Checking $jar..."
          if unzip -t "$jar" > /dev/null 2>&1; then
            echo "  ✓ Valid JAR"
          else
            echo "  ✗ Invalid or empty JAR"
            ls -la "$jar"
          fi
        done

    - name: Build with Maven
      run: mvn package -DskipTests --batch-mode

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ConstructModV2
        path: target/ConstructModV2.jar
        if-no-files-found: error

  # Create a release when pushing a tag
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: ConstructModV2

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ConstructModV2.jar
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
