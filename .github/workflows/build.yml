name: Build Mod

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Create lib directory
      run: mkdir -p ../lib

    - name: Download ModTheSpire
      run: |
        # ModTheSpire releases as a ZIP file containing the JAR
        echo "Downloading ModTheSpire..."
        curl -L -f -o /tmp/ModTheSpire.zip \
          "https://github.com/kiooeht/ModTheSpire/releases/download/v3.6.3/ModTheSpire.zip"
        echo "Extracting ModTheSpire.jar from ZIP..."
        unzip -j /tmp/ModTheSpire.zip "ModTheSpire.jar" -d ../lib/ || \
        unzip -j /tmp/ModTheSpire.zip "*/ModTheSpire.jar" -d ../lib/ || \
        unzip -l /tmp/ModTheSpire.zip  # Show contents if extraction fails
        ls -la ../lib/ModTheSpire.jar

    - name: Download BaseMod
      run: |
        echo "Downloading BaseMod..."
        curl -L -f -o ../lib/BaseMod.jar \
          "https://github.com/daviscook477/BaseMod/releases/download/v5.5.0/BaseMod.jar"
        ls -la ../lib/BaseMod.jar

    - name: Download StSLib
      run: |
        echo "Downloading StSLib..."
        curl -L -f -o ../lib/StSLib.jar \
          "https://github.com/kiooeht/StSLib/releases/download/v1.10.0/StSLib.jar"
        ls -la ../lib/StSLib.jar

    - name: Download Slay the Spire desktop JAR (stub)
      run: |
        echo "Downloading STS desktop stub..."
        # Use the community-maintained mod compile dependencies
        # This contains only the class signatures needed for compilation
        curl -L -f -o ../lib/desktop-1.0.jar \
          "https://raw.githubusercontent.com/Gremious/StS-DefaultModBase/master/lib/desktop-1.0.jar" || \
        curl -L -f -o ../lib/desktop-1.0.jar \
          "https://github.com/Alchyr/BasicMod/raw/master/lib/desktop-1.0.jar" || {
          echo "WARNING: Could not download desktop-1.0.jar stub"
          echo "Build will likely fail - game JAR needed for compilation"
          # Create minimal empty jar as last resort
          echo "Manifest-Version: 1.0" > manifest.txt
          jar cfm ../lib/desktop-1.0.jar manifest.txt
          rm manifest.txt
        }
        ls -la ../lib/desktop-1.0.jar

    - name: Create placeholder for optional dependencies
      run: |
        # ReplayTheSpire is optional, create empty JAR
        echo "Manifest-Version: 1.0" > manifest.txt
        jar cfm ../lib/ReplayTheSpireMod.jar manifest.txt
        rm manifest.txt
        ls -la ../lib/

    - name: Verify downloaded JARs
      run: |
        echo "Verifying JAR files..."
        for jar in ../lib/*.jar; do
          echo "Checking $jar..."
          if unzip -t "$jar" > /dev/null 2>&1; then
            echo "  ✓ Valid JAR"
          else
            echo "  ✗ Invalid or empty JAR"
            ls -la "$jar"
          fi
        done

    - name: Build with Maven
      run: mvn package -DskipTests --batch-mode

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ConstructModV2
        path: target/ConstructModV2.jar
        if-no-files-found: error

  # Create a release when pushing a tag
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: ConstructModV2

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ConstructModV2.jar
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
